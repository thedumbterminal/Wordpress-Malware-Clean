#!/usr/bin/env perl
use strict;
use warnings;
use Carp;
use Data::Dumper;
use File::Temp;
use lib qw(lib ../lib);
use Wordpress::Malware::Clean::Dir;
use Wordpress::Malware::Clean::Detector;
if($#ARGV == 0){
	my $infected = Wordpress::Malware::Clean::Dir->new($ARGV[0]);
	my $temp = File::Temp->newdir(CLEANUP => 0);
	$infected->setCleanBaseDirectory($temp);
	my $index = Wordpress::Malware::Clean::File->new(File::Spec->catfile($infected->getPath(), "index.php"));
	print "Detecting malware signature in: " . $index->getPath() . "\n";
	my $sig = Wordpress::Malware::Clean::Detector->detect($index);
	if($sig){
		print "Found signature:\n" . $sig . "\n";
		print "Looks ok? (y/n): ";
		my $answer = <STDIN>;
		chomp $answer;
		if($answer eq "y"){
			print "Scanning: " . $infected->getPath() . "\n";
			my @dirsToProcess = ($infected);	#set starting point
			while(my $currentDir = shift(@dirsToProcess)){	#process all pending dirs
				$currentDir->doProcess();
				foreach my $file ($currentDir->getFiles()){
					$file->doProcess($sig);
				}
				push(@dirsToProcess, $currentDir->getChildDirectories());	#need to process this directories too
			}
		}
		else{
			die("Aborted\n");
		}
	}
	else{
		die("No malware signature found\n");
	}
	print "Clean files saved to: " . $temp->dirname() . "\n";
	print "...done\n";
}
else{
	die("Usage: $0 <infected dir>\n");
}