package Wordpress::Malware::Clean;
use strict;
use warnings;
use File::Temp;
use Wordpress::Malware::Clean::File;
use Wordpress::Malware::Clean::Detector;
use Wordpress::Malware::Clean::Dir;
our $VERSION = "1.0";
########################################################################
sub new{
	my($class, $infectedDir) = @_;
	my $self = {
		"__infected" => undef,
		"__clean" => undef,
		"__signature" => undef
	};
	bless $self, $class;
	$self->__setInfected($infectedDir);
	$self->__setClean();
	$self->__initInfected();
	$self->__setSignature();
	return $self;
}
########################################################################
sub getClean{
	my $self = shift;
	return $self->{'__clean'};
}
########################################################################
sub getSignature{
	my $self = shift;
	return $self->{'__signature'};
}
########################################################################
sub doProcess{
	my $self = shift;
	my $infected = $self->__getInfected();
	my @dirsToProcess = ($infected);	#set starting point
	print STDERR "Scanning: " . $infected->getPath() . "\n";
	while(my $currentDir = shift(@dirsToProcess)){	#process all pending dirs
		$currentDir->doProcess();
		foreach my $file ($currentDir->getFiles()){
			$file->doProcess($self->getSignature());
		}
		push(@dirsToProcess, $currentDir->getChildDirectories());	#need to process this directories too
	}
	return 1;	
}
########################################################################
sub __setSignature{
	my $self = shift;
	my $index = $self->__getIndex();	
	print STDERR "Detecting malware signature in: " . $index->getPath() . "\n";
	$self->{'__signature'} = Wordpress::Malware::Clean::Detector->detect($index);
	return 1;
}
########################################################################
sub __initInfected{
	my $self = shift;
	my $infected = $self->__getInfected();
	my $temp = $self->getClean();
	$infected->setCleanBaseDirectory($temp);
	return 1;
}
########################################################################
sub __getIndex{
	my $self = shift;
	my $infected = $self->__getInfected();
	my $index = Wordpress::Malware::Clean::File->new(File::Spec->catfile($infected->getPath(), "index.php"));
	return $index;	
}
########################################################################
sub __setClean{
	my $self = shift;
	my $temp = File::Temp->newdir(CLEANUP => 0);
	$self->{'__clean'} = $temp;
	return 1;	
}
########################################################################
sub __getInfected{
	my $self = shift;
	return $self->{'__infected'};
}
########################################################################
sub __setInfected{
	my($self, $infectedDir) = @_;
	my $infected = Wordpress::Malware::Clean::Dir->new($infectedDir);
	$self->{'__infected'} = $infected;
	return 1;
}
########################################################################
return 1;
